<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Triad MDR Assistant</title>
<style>
  :root{
    /* Triad brand palette */
    --triad-deep-teal:#0C6D72;  /* deep teal */
    --triad-seafoam:#6AD5C5;    /* light teal / seafoam */
    --triad-gold:#F2C14E;       /* golden yellow */
    --ink:#0f172a;
    --muted:#475569;
    --line:#e2e8f0;
    --bg:#f7faf9;
    --card:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
  a{color:var(--triad-deep-teal);text-decoration:none}
  .container{max-width:1100px;margin:0 auto;padding:20px}
  header{position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line);z-index:10}
  .header-inner{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 20px;max-width:1100px;margin:0 auto}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--triad-deep-teal),var(--triad-seafoam));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;overflow:hidden}
  .logo img{display:block;height:100%;width:100%;object-fit:contain}
  .title{font-weight:700;letter-spacing:.2px}
  .subtitle{font-size:12px;color:var(--muted)}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-size:14px}
  .btn:hover{background:#f8fafc}
  .btn.primary{background:var(--triad-deep-teal);border-color:var(--triad-deep-teal);color:#fff}
  .btn.primary:hover{background:#09565a}
  .btn.gold{background:var(--triad-gold);border-color:var(--triad-gold);color:#0f172a}
  .progress{height:6px;background:var(--line)}
  .progress > div{height:6px;background:linear-gradient(90deg,var(--triad-deep-teal),var(--triad-seafoam));transition:width .25s ease}
  main{display:grid;grid-template-columns:1fr;gap:20px;padding:20px}
  @media(min-width:980px){ main{grid-template-columns: 1fr 2fr;} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:18px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
  .stack-12 > * + *{margin-top:12px}
  .stack-16 > * + *{margin-top:16px}
  .stack-8 > * + *{margin-top:8px}
  .grid{display:grid;grid-template-columns: 140px 1fr;gap:10px;align-items:center}
  .input, .textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px;background:#fff}
  .textarea{min-height:120px;resize:vertical}
  .trace{max-height:52vh;overflow:auto}
  ol{padding-left:18px}
  .trace li{border:1px solid var(--line);border-radius:12px;padding:10px;margin:8px 0}
  .muted{color:var(--muted)}
  .hstack{display:flex;flex-wrap:wrap;gap:10px}
  .options{display:flex;flex-wrap:wrap;gap:10px}
  .option{padding:10px 14px;border:1px solid var(--line);border-radius:20px;background:#fff;cursor:pointer}
  .option.selected{box-shadow:0 0 0 3px var(--triad-seafoam)}
  .section-title{font-weight:700;margin:4px 0;font-size:18px}
  .summary-verdict{border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:10px;background:linear-gradient(180deg,#fff, #fbfdfd)}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#fff}
  footer{max-width:1100px;margin:0 auto;padding:0 20px 28px;color:var(--muted);font-size:12px}
  .tiny{font-size:12px}
  .pill{padding:3px 10px;border-radius:999px;background:var(--triad-seafoam);color:#083a39;font-weight:600}
  .logo-input{width:340px}
  @media print {
    header, .no-print { display:none !important; }
    body{background:#fff}
  }
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo" id="logoBox">T</div>
      <div>
        <div class="title">Triad Manifestation Determination Assistant</div>
        <div class="subtitle">IDEA two-prong test with special-circumstances branch, notes, and Word export.</div>
      </div>
    </div>
    <div class="hstack no-print">
      <input id="logoUrl" class="input logo-input" placeholder="Paste logo image URL (optional)"/>
      <button class="btn" id="saveLogoBtn" title="Save logo URL">Save Logo</button>
      <button class="btn" id="restartBtn" title="Reset and start over">Restart</button>
      <button class="btn primary" id="exportDocBtn" title="Export a Word document summary">Export Word</button>
    </div>
  </div>
  <div class="progress"><div id="progressBar" style="width:0%"></div></div>
</header>

<main class="container">
  <section class="card stack-12 no-print">
    <div class="section-title">Case Details</div>
    <div class="grid">
      <label class="muted tiny">Initials</label>
      <input id="stInitials" class="input" />
      <label class="muted tiny">Student ID</label>
      <input id="stId" class="input" />
      <label class="muted tiny">Date</label>
      <input id="stDate" class="input" type="date" />
    </div>
  </section>

  <section class="card stack-16" id="mainCard">
    <!-- dynamic content injected here -->
  </section>

  <section class="card stack-12 no-print">
    <div class="section-title">Decision Trace</div>
    <ol id="traceList" class="trace"></ol>
  </section>

  <section class="card stack-12">
    <div class="hstack" style="justify-content:space-between">
      <div class="section-title">About this tool</div>
      <button class="btn no-print" id="toggleAbout">Show</button>
    </div>
    <div id="aboutContent" style="display:none" class="muted stack-8">
      <p>This interactive decision tree mirrors the IDEA two-prong test at 34 CFR §300.530(e) and includes a special-circumstances branch under §300.530(g) (weapons, drugs, serious bodily injury) allowing removal to an IAES for up to 45 school days. The MDR still occurs.</p>
      <ul>
        <li>Back / Restart to navigate; notes are saved to your browser.</li>
        <li>Use <b>Export Word</b> for a .doc you can file; or browser <b>Print</b> to PDF.</li>
        <li>Customize the flow in this file to align with local procedures.</li>
      </ul>
      <p class="muted">Informational tool only — not legal advice.</p>
    </div>
  </section>
</main>

<footer>© <span id="year"></span> Triad Psychoeducational Services — Assistant for school teams. Not legal advice.</footer>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const STORAGE_KEY = "triad-mdr-flow-v2";
  const STUDENT_KEY = "triad-mdr-student-v2";
  const LOGO_KEY = "triad-mdr-logo-url";

  // ----- FLOW DEFINITION -----
  // Special-circumstances node (weapons, drugs, SBI) indicates 45-day IAES permitted regardless of MDR result. MDR still occurs.
  const FLOW = [
    {
      id: "start",
      title: "Disciplinary Change of Placement?",
      body: "Is the removal a change of placement (e.g., >10 consecutive days, a pattern totaling >10 cumulative days, or substantially similar behaviors forming a pattern)?",
      options: [
        { id: "start_yes", label: "Yes — change of placement", nextId: "special" },
        { id: "start_no", label: "No — not a change of placement", nextId: "consider_optional" }
      ]
    },
    {
      id: "special",
      title: "Special Circumstances under §300.530(g)?",
      body: "Does the conduct involve weapons, illegal drugs, or serious bodily injury? If yes, the district may place the student in an Interim Alternative Educational Setting (IAES) for up to 45 school days, regardless of the MDR outcome. The MDR still occurs.",
      options: [
        { id: "sp_yes", label: "Yes — weapons/drugs/SBI involved", nextId: "team", flagIAES: true },
        { id: "sp_no", label: "No — proceed with standard MDR", nextId: "team" }
      ]
    },
    {
      id: "consider_optional",
      title: "MDR Not Typically Required",
      body: "If this is not a change of placement, an MDR is generally not required under IDEA. Follow standard discipline with protections for students with disabilities; consult district policy for cumulative days/patterns.",
      options: [
        { id: "opt_done", label: "Finish — MDR not required", outcome: { verdict: "Not Required", notes: "Not a change of placement." } },
        { id: "opt_continue", label: "Proceed anyway (best practice)", nextId: "team" }
      ]
    },
    {
      id: "team",
      title: "Team & Records Review (Step-by-Step)",
      body: "Ensure parent and relevant IEP team members are present. Complete the structured review below.",
      requireMulti: [
        { id: "parent_input", label: "Parent Input" },
        { id: "teacher_input", label: "Teacher Input" },
        { id: "assessment_data", label: "Assessment / Evaluation Data" },
        { id: "service_logs", label: "Service Logs / Implementation Evidence" },
        { id: "fidelity_checks", label: "IEP Fidelity Checks" },
        { id: "other_info", label: "Other Relevant Information" }
      ],
      options: [{ id: "team_ready", label: "Completed — continue", nextId: "prongA" }]
    },
    {
      id: "prongA",
      title: "Prong A — Relationship to Disability",
      body: "Was the conduct caused by, or did it have a direct and substantial relationship to, the child's disability?",
      requireNote: true,
      options: [
        { id: "A_yes", label: "Yes", outcome: { verdict: "Manifestation: YES", notes: "Conduct had a direct and substantial relationship to disability." } },
        { id: "A_no", label: "No", nextId: "prongB" },
        { id: "A_unsure", label: "Unsure — seek more data", nextId: "data_gap" }
      ]
    },
    {
      id: "prongB",
      title: "Prong B — Implementation of IEP",
      body: "Was the conduct the direct result of the LEA's failure to implement the IEP?",
      requireNote: true,
      options: [
        { id: "B_yes", label: "Yes", outcome: { verdict: "Manifestation: YES", notes: "Direct result of failure to implement IEP." } },
        { id: "B_no", label: "No", outcome: { verdict: "Manifestation: NO", notes: "Neither prong A nor B met." } },
        { id: "B_unsure", label: "Unsure — seek more data", nextId: "data_gap" }
      ]
    },
    {
      id: "data_gap",
      title: "Data Gap / More Information Needed",
      body: "Collect additional information (e.g., updated teacher input, FBA/BIP review, service logs, fidelity checks). Consider pausing disciplinary changes until the team can reconvene with adequate data.",
      requireNote: true,
      options: [
        { id: "gap_backA", label: "Reassess Prong A", nextId: "prongA" },
        { id: "gap_backB", label: "Reassess Prong B", nextId: "prongB" }
      ]
    }
  ];

  // ----- Helpers & elements -----
  const $ = (id)=>document.getElementById(id);
  const yearEl = $("year"); yearEl.textContent = new Date().getFullYear();

  const stInitials = $("stInitials");
  const stId = $("stId");
  const stDate = $("stDate");
  const mainCard = $("mainCard");
  const traceList = $("traceList");
  const restartBtn = $("restartBtn");
  const exportDocBtn = $("exportDocBtn");
  const progressBar = $("progressBar");
  const toggleAbout = $("toggleAbout");
  const aboutContent = $("aboutContent");
  const logoUrlInput = $("logoUrl");
  const saveLogoBtn = $("saveLogoBtn");
  const logoBox = $("logoBox");

  toggleAbout.addEventListener("click", () => {
    const open = aboutContent.style.display !== "none";
    aboutContent.style.display = open ? "none" : "block";
    toggleAbout.textContent = open ? "Show" : "Hide";
  });

  function formatDate(d){
    const pad = (n)=> String(n).padStart(2,"0");
    return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
  }

  function setLogo(url){
    // If URL provided and valid, show image; else show gradient T
    if(url && /^https?:/.test(url)){
      logoBox.innerHTML = '<img alt="Triad logo" />';
      const img = logoBox.querySelector("img");
      img.src = url;
      logoBox.style.background = "#fff";
      logoBox.style.border = "1px solid var(--line)";
    } else {
      logoBox.innerHTML = "T";
      logoBox.style.background = "linear-gradient(135deg,var(--triad-deep-teal),var(--triad-seafoam))";
      logoBox.style.border = "none";
    }
  }

  // State
  let history = [{ nodeId: "start" }];
  let student = { initials: "", id: "", date: formatDate(new Date()) };
  let flags = { IAES: false };
  let multiNotes = {}; // for requireMulti section

  // Load from storage
  try{
    const h = localStorage.getItem(STORAGE_KEY);
    const s = localStorage.getItem(STUDENT_KEY);
    if(h) {
      const parsed = JSON.parse(h);
      history = parsed.history || history;
      flags = parsed.flags || flags;
      multiNotes = parsed.multiNotes || {};
    }
    if(s) student = JSON.parse(s);
  }catch(e){}

  // Load logo
  try{
    const url = localStorage.getItem(LOGO_KEY) || "";
    logoUrlInput.value = url;
    setLogo(url);
  }catch(e){}

  saveLogoBtn.addEventListener("click", () => {
    const url = logoUrlInput.value.trim();
    localStorage.setItem(LOGO_KEY, url);
    setLogo(url);
  });

  // Apply student
  stInitials.value = student.initials || "";
  stId.value = student.id || "";
  stDate.value = student.date || formatDate(new Date());
  stInitials.addEventListener("input", saveStudent);
  stId.addEventListener("input", saveStudent);
  stDate.addEventListener("input", saveStudent);

  function saveStudent(){
    student = { initials: stInitials.value, id: stId.value, date: stDate.value };
    localStorage.setItem(STUDENT_KEY, JSON.stringify(student));
  }

  restartBtn.addEventListener("click", () => {
    history = [{ nodeId: "start" }];
    flags = { IAES: false };
    multiNotes = {};
    saveHistory();
    render();
  });

  function saveHistory(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ history, flags, multiNotes }));
  }

  function findNode(id){ return FLOW.find(n => n.id === id); }

  function computePath(){
    return history.map(step => {
      const node = findNode(step.nodeId);
      const choice = step.optionId ? (node ? node.options.find(o => o.id === step.optionId) : undefined) : undefined;
      return { node, choice, note: step.note };
    }).filter(p => !!p.node);
  }

  function currentStep(){ return history[history.length-1]; }
  function currentNode(){ return findNode(currentStep().nodeId); }

  function currentOutcome(){
    const node = currentNode();
    if(!node) return null;
    const step = currentStep();
    if(!step.optionId) return null;
    const opt = node.options.find(o => o.id === step.optionId);
    return opt && opt.outcome ? opt.outcome : null;
  }

  function progressPercent(){
    const answered = history.filter(s => !!s.optionId).length;
    const denom = Math.max(answered + 2, 3);
    return Math.min(100, Math.round((answered/denom)*100));
  }

  function pick(opt){
    // If special-circumstances chosen, set IAES flag
    if(opt.flagIAES){ flags.IAES = true; }
    // set choice
    history[history.length-1].optionId = opt.id;
    // push next step if any
    if(opt.nextId){
      history.push({ nodeId: opt.nextId });
    }
    saveHistory();
    render();
  }

  function updateNote(val){
    history[history.length-1].note = val;
    saveHistory();
  }

  function updateMultiNote(id, val){
    multiNotes[id] = val;
    saveHistory();
  }

  function goBack(){
    if(history.length > 1){
      history.pop();
      // if we step back to 'special', IAES may be reset later if not reselected
      const lastNode = currentNode();
      if(lastNode && lastNode.id === "special"){
        flags.IAES = false;
      }
      saveHistory();
      render();
    }
  }

  function render(){
    // progress
    progressBar.style.width = progressPercent()+"%";

    // left trace
    const path = computePath();
    traceList.innerHTML = "";
    for(const p of path){
      const li = document.createElement("li");
      const title = document.createElement("div");
      title.style.fontWeight = "700";
      title.textContent = p.node.title;
      li.appendChild(title);
      if(p.choice){
        const c = document.createElement("div");
        c.className = "muted tiny";
        c.textContent = "Choice: " + p.choice.label;
        li.appendChild(c);
      }
      if(p.note){
        const n = document.createElement("div");
        n.className = "muted tiny";
        n.style.whiteSpace = "pre-wrap";
        n.textContent = p.note;
        li.appendChild(n);
      }
      traceList.appendChild(li);
    }

    // main card
    const outcome = currentOutcome();
    if(outcome){
      renderSummary(outcome, path);
      return;
    }

    const node = currentNode();
    let html = "";
    html += `<div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">`;
    html += `<div><div class="section-title" style="font-size:20px">${node.title}</div>`;
    if(node.body){ html += `<p class="muted" style="max-width:70ch">${node.body}</p>`; }
    html += `</div>`;
    html += `<div class="hstack no-print">`;
    html += `<button class="btn" id="backBtn" ${history.length<=1?"disabled":""}>Back</button>`;
    html += `</div></div>`;

    // Multi-field step-by-step area
    if(node.requireMulti){
      html += `<div class="stack-12">`;
      for(const f of node.requireMulti){
        const val = (multiNotes[f.id] || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        html += `<div>
          <label class="tiny muted" style="display:block;margin-bottom:6px">${f.label}</label>
          <textarea class="textarea" data-multi="${f.id}" placeholder="${f.label} notes...">${val}</textarea>
        </div>`;
      }
      html += `</div>`;
    }

    if(node.requireNote){
      const noteVal = (currentStep().note||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      html += `<div class="stack-8">
        <label class="tiny muted" style="display:block">Rationale / Notes</label>
        <textarea class="textarea" id="noteArea" placeholder="Summarize key data reviewed and the team's reasoning for this step.">${noteVal}</textarea>
      </div>`;
    }

    // Options
    html += `<div class="options">`;
    for(const opt of node.options){
      const selected = currentStep().optionId === opt.id;
      html += `<button class="option ${selected?"selected":""}" data-opt="${opt.id}">${opt.label}</button>`;
    }
    html += `</div>`;

    mainCard.innerHTML = html;

    const backBtn = document.getElementById("backBtn");
    if(backBtn){ backBtn.addEventListener("click", goBack); }

    const noteArea = document.getElementById("noteArea");
    if(noteArea){ noteArea.addEventListener("input", (e)=> updateNote(e.target.value)); }

    // listeners for multi textareas
    mainCard.querySelectorAll("textarea[data-multi]").forEach(area => {
      area.addEventListener("input", () => {
        const id = area.getAttribute("data-multi");
        updateMultiNote(id, area.value);
      });
    });

    mainCard.querySelectorAll("button.option").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-opt");
        const node = currentNode();
        const opt = node.options.find(o => o.id === id);
        if(opt) pick(opt);
      });
    });
  }

  function renderSummary(outcome, path){
    let html = "";
    html += `<div class="section-title" style="font-size:20px">Summary & Decision</div>`;
    html += `<div class="muted tiny">Student ${escapeHtml(student.initials||"—")} • ID ${escapeHtml(student.id||"—")} • ${escapeHtml(student.date)}</div>`;
    html += `<div class="summary-verdict"><div class="tiny muted">Final Verdict</div>`;
    html += `<div style="font-size:22px;font-weight:700">${escapeHtml(outcome.verdict)}</div>`;
    if(outcome.notes){ html += `<div class="muted" style="margin-top:6px">${escapeHtml(outcome.notes)}</div>`; }
    if(flags.IAES){ html += `<div style="margin-top:8px"><span class="pill">IAES up to 45 school days permitted (300.530(g))</span></div>`; }
    html += `</div>`;

    // Step-by-step review content
    const keys = ["parent_input","teacher_input","assessment_data","service_logs","fidelity_checks","other_info"];
    const labels = {
      parent_input:"Parent Input",
      teacher_input:"Teacher Input",
      assessment_data:"Assessment / Evaluation Data",
      service_logs:"Service Logs / Implementation Evidence",
      fidelity_checks:"IEP Fidelity Checks",
      other_info:"Other Relevant Information"
    };
    const hasMulti = keys.some(k => (multiNotes[k]||"").trim().length);
    if(hasMulti){
      html += `<div class="section-title" style="margin-top:14px">Team & Records Review</div>`;
      html += `<div class="stack-12">`;
      for(const key of keys){
        const val = multiNotes[key];
        if(typeof val === "string" && val.trim().length){
          html += `<div><div class="tiny muted">${labels[key]}</div><div>${escapeHtml(val).replace(/\n/g,"<br/>")}</div></div>`;
        }
      }
      html += `</div>`;
    }

    html += `<div class="section-title" style="margin-top:14px">Decision Trace</div>`;
    html += `<ol>`;
    for(const p of path){
      html += `<li class="trace-li" style="border:1px solid var(--line);border-radius:12px;padding:10px;margin:8px 0">`;
      html += `<div style="font-weight:700">${escapeHtml(p.node.title)}</div>`;
      if(p.choice){ html += `<div class="muted tiny">Choice: ${escapeHtml(p.choice.label)}</div>`; }
      if(p.note){ html += `<div class="muted tiny" style="white-space:pre-wrap">${escapeHtml(p.note)}</div>`; }
      html += `</li>`;
    }
    html += `</ol>`;

    html += `<div class="muted tiny">If <b>Manifestation: YES</b>: conduct/adjust FBA/BIP as needed and return the student to the placement unless parent and LEA agree otherwise. If <b>Manifestation: NO</b>: proceed with discipline applicable to students without disabilities, while ensuring services continue for participation/progress in curriculum and IEP goals.</div>`;

    mainCard.innerHTML = html;
  }

  function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

  // Export Word (.doc) using HTML content (Word-compatible)
  exportDocBtn.addEventListener("click", () => {
    const path = computePath();
    const outcome = currentOutcome();
    const iaes = flags.IAES;
    const labels = {
      parent_input:"Parent Input",
      teacher_input:"Teacher Input",
      assessment_data:"Assessment / Evaluation Data",
      service_logs:"Service Logs / Implementation Evidence",
      fidelity_checks:"IEP Fidelity Checks",
      other_info:"Other Relevant Information"
    };
    let html = "";
    html += `<!DOCTYPE html><html><head><meta charset="utf-8"><title>MDR Summary</title>`;
    html += `<style>body{font-family:Calibri,Arial,sans-serif;color:#111} h1{font-size:20pt;margin:0 0 6pt} h2{font-size:14pt;margin:14pt 0 6pt} .muted{color:#555} .box{border:1px solid #ddd;padding:8pt;border-radius:6pt;margin:6pt 0} .pill{display:inline-block;background:#6AD5C5;padding:2pt 6pt;border-radius:999pt;font-weight:bold;color:#083a39} </style>`;
    html += `</head><body>`;
    // Header with logo if available
    const logoUrl = localStorage.getItem(LOGO_KEY);
    if(logoUrl && /^https?:/.test(logoUrl)){
      html += `<div style="display:flex;align-items:center;gap:10pt"><img src="${logoUrl}" style="height:28pt;border:1pt solid #eee;border-radius:6pt"/><div><h1>Triad Manifestation Determination Summary</h1><div class="muted">IDEA 34 CFR §300.530</div></div></div>`;
    } else {
      html += `<h1>Triad Manifestation Determination Summary</h1><div class="muted">IDEA 34 CFR §300.530</div>`;
    }
    html += `<div class="muted">Student ${escapeHtml(student.initials||"—")} • ID ${escapeHtml(student.id||"—")} • ${escapeHtml(student.date)}</div>`;

    if(outcome){
      html += `<h2>Final Verdict</h2><div class="box"><div style="font-size:14pt;font-weight:bold">${escapeHtml(outcome.verdict)}</div>`;
      if(outcome.notes){ html += `<div class="muted">${escapeHtml(outcome.notes)}</div>`; }
      if(iaes){ html += `<div style="margin-top:6pt"><span class="pill">IAES up to 45 school days permitted (300.530(g))</span></div>`; }
      html += `</div>`;
    }

    // Team & Records Review section
    const keys = ["parent_input","teacher_input","assessment_data","service_logs","fidelity_checks","other_info"];
    const hasMulti = keys.some(k => (multiNotes[k]||"").trim().length);
    if(hasMulti){
      html += `<h2>Team & Records Review</h2>`;
      for(const key of keys){
        const val = multiNotes[key];
        if(typeof val === "string" && val.trim().length){
          html += `<div class="box"><div class="muted">${labels[key]}</div><div>${escapeHtml(val).replace(/\n/g,"<br/>")}</div></div>`;
        }
      }
    }

    // Decision Trace
    html += `<h2>Decision Trace</h2>`;
    for(const p of path){
      html += `<div class="box"><div style="font-weight:bold">${escapeHtml(p.node.title)}</div>`;
      if(p.choice){ html += `<div class="muted">Choice: ${escapeHtml(p.choice.label)}</div>`; }
      if(p.note){ html += `<div class="muted">${escapeHtml(p.note).replace(/\n/g,"<br/>")}</div>`; }
      html += `</div>`;
    }

    html += `<p class="muted">If <b>Manifestation: YES</b>: conduct/adjust FBA/BIP as needed and return the student to the placement unless parent and LEA agree otherwise. If <b>Manifestation: NO</b>: proceed with discipline applicable to students without disabilities, while ensuring services continue for participation/progress in curriculum and IEP goals.</p>`;

    html += `</body></html>`;
    const blob = new Blob([html], {type:"application/msword;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `MDR_${student.initials||"student"}_${student.date}.doc`;
    a.click();
    URL.revokeObjectURL(url);
  });

  render();
});
</script>
</body>
</html>
